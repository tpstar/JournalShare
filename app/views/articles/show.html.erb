<h2>Posted Article</h2>

<p class="articleTitle">
  <%= @article.title if @article.title%>
</p>


<p id="articleInfo">
  <i><%=@article.journal.name if @article.journal%></i>
  <strong><%= @article.year if @article.year%></strong>
  <i><%= @article.vol if @article.vol%></i>
  <%= "(#{@article.issue})" if @article.issue%>
  <%= "p#{@article.start_page}" if @article.start_page %>
</p>

<p id="articleDOI">
  DOI: <%= @article.doi %>
</p>

<p id="articleUser">
  <% if @article.users.any? %>
    posted <span id="author">by <%= @article.users.last.first_name%> <%= @article.users.last.last_name%></span>
  <% end %>
</p>

<p id="currentUser">
  <% if @article.users.include?(current_user) %>
    <font color="blue">You are the author of the article</font>
  <% elsif @article.demands.include?(Demand.find_by(reader_id: current_user.id)) %>
    <font color="red">You have already requested the article.</font>
  <% else %>
    <%= render partial: 'request_form', locals: {article: @article} %>
  <% end %>
</p>
<div id="anotherForm">
  <%= render partial: 'another_form', locals: {article: @article} %>
</div>
<p id="requestNotification">
<p>

<a href="#" class="js-next" data-id="<%=@article.id%>">Next Article</a>

<script type="text/javascript" charset="utf-8">

$(function() {
  initializePage();
  nextArticle();
  requestArticle();
});


function nextArticle() {
  $(".js-next").on("click", function(event){
    var nextId = parseInt($(".js-next").attr("data-id")) + 1;
    $.get("/articles/" + nextId + ".json", function(article) {
      $(".articleTitle").text(article["title"]);
      $("#articleInfo").html( articleListEntry(article) );
      $("#articleDOI").text("DOI: " + article["doi"]);
      $("#author").text(byAuthor(article));

      $(".js-next").attr("data-id", article["id"]);
      initializePage();
    });
    event.preventDefault();
  });
}

function requestArticle() {
  $('form').submit(function(event) {
    //prevent form from submitting the default way
    event.preventDefault();
    var values = $(this).serialize();
    $.post(this.action, values, function(data){
      $("#requestNotification").html("<font color='green'>" + data.notification + "</font>")
    });
  });
}

function initializePage() {
  var userId = parseInt($(".js-next").attr("data-id"));
  var article = getArticleInfo(userId);


  console.log(article.id);
  // $.get('/present_user', function(data) {
  //   var currentUserId = data["id"];
  //   var authors = article["users"];
  //   var userIds = [];
  //   authors.forEach(function(author) {
  //     userIds.push(author.id);
  //   })
  //
  //   if(userIds.includes(currentUserId)) {
  //     $("#currentUser").html("<font color='blue'>You are the author of the article</font>");
  //     $("#article_request_form").hide();
  //   } else {
  //     // display article request form
  //
  //     // $.get("/articles/" + nextId, function(data) {
  //     //  $("#currentUser").html($(data).find('form'));
  //     // });
  //
  //     $("#currentUser").hide();

  //   };
  // });
}

function getArticleInfo(userId) {
  $.get("/articles/" + userId + ".json", function(article) {
    return article;
  })
}

</script>
