<h2>Posted Article</h2>

<p class="articleTitle">
  <%= @article.title if @article.title%>
</p>


<p id="articleInfo">
  <i><%=@article.journal.name if @article.journal%></i>
  <strong><%= @article.year if @article.year%></strong>
  <i><%= @article.vol if @article.vol%></i>
  <%= "(#{@article.issue})" if @article.issue%>
  <%= "p#{@article.start_page}" if @article.start_page %>
</p>

<p id="articleDOI">
  DOI: <%= @article.doi %>
</p>

<p id="articleUser">
  <% if @article.users.any? %>
    posted <span id="author">by <%= @article.users.last.first_name%> <%= @article.users.last.last_name%></span>
  <% end %>
</p>

<p id="currentUser">
  <% if @article.users.include?(current_user) %>
    <font color="blue">You are the author of the article</font>
  <% elsif @article.demands.include?(Demand.find_by(reader_id: current_user.id)) %>
    <font color="red">You have already requested the article></font>
  <% else %>
    <%= render partial: 'request_form', locals: {article: @article} %>
  <% end %>
</p>
<br>

<a href="#" class="js-next" data-id="<%=@article.id%>">Next Article</a>

<script type="text/javascript" charset="utf-8">

$(function() {
  $(".js-next").on("click", function(event){
    var nextId = parseInt($(".js-next").attr("data-id")) + 1;
    $.get("/articles/" + nextId + ".json", function(article) {
      $(".articleTitle").text(article["title"]);
      $("#articleInfo").html( articleListEntry(article) );
      $("#articleDOI").text("DOI: " + article["doi"]);
      $("#author").text(byAuthor(article));
      $.get('/present_user', function(data) {
        var currentUserId = data["id"];
        var authors = article["users"];
        var userIds = [];
        authors.forEach(function(el) {
          userIds.push(el.id);
        })

        if(userIds.includes(currentUserId)) {
          $("#currentUser").html("<font color='blue'>You are the author of the article</font>");
        } else {
          $.get("/articles/" + nextId, function(data) {

            console.log(data)
            // $("#currentUser").html( html.getElementsByTagName("FORM") );
            })
          // $("#currentUser").html("<button class='btn btn-primary'>Request this Article from its Author</button>")
          // requestArticle();
        };
      });
      $(".js-next").attr("data-id", article["id"]);
    });
    event.preventDefault();
  });

});

function requestArticle() {
  var form = $('<form></form>');
  form.attr("method", "post");
  form.attr("action", "/demands");

  // form.append("<input name='utf8' value='âœ“' type='hidden'>")
  // form.append("<input type='hidden' name='authenticity_token' value=" + $('meta[name=csrf-token]').attr('content') + "/>")
  form.append("<input class='btn btn-primary' name='commit' value='Request this Article from its Author' type='submit'>");

  // console.log($('meta[name=csrf-token]').attr('content'));

  var hiddenValues = {"author_id": "1", "reader_id": "2", "article_id": "3" };

  $.each(hiddenValues, function(key, value) {
    var field = $('<input></input>');

    field.attr("type", "hidden");
    field.attr("name", key);
    field.attr("value", value);

    form.append(field);
  });

  $("#currentUser").html(form);
  console.log(form)

  // form.submit();
}

function formSubmit() {
  $('form').submit(function(event) {
    //prevent form from submitting the default way
    event.preventDefault();
    var hiddenValues = {author_id: 1, reader_id: 2, article_id: 1 };
    var values = $(hiddenValues).serialize();
    var posting = $.post('/demands', values);
    posting.done(function(demand) {
      console.log(demand);
    })
  });
}

// function requestArticle() {
//   $(".btn").on("click", function(){
//     var hiddenValues = {author_id: 1, reader_id: 2, article_id: 1 };
//     var values = $(hiddenValues).serialize();
//     var posting = $.post('/demands', values);
//     posting.done(function(demand) {
//       console.log(demand);
//     })
//   });
// }

</script>
